@model IEnumerable<Eyewear_Store_System.Models.Invoice>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}
<div id="app">
    
    <div class="alert alert-primary">
        <h2>Invoices</h2>
    </div>

    @using (Html.BeginForm("Search", "Invoices", FormMethod.Post))
    {
        <div class="row justify-content-center">
            <div class="col-md-2">
                    <input type="search" name="InvoiceId" placeholder="Invoice Number" class="form-control" />
            </div>
            <div class="col-md-2">
                
                    <input type="search" name="ClientName" placeholder="Client Name" class="form-control">
                
                    <input type="search" name="ClientPhoneNumber" placeholder="Client Phone" class="form-control">
                
            </div>
            <div class="col-md-3">
                <div class="form-group input-group">
                    <span class="input-group-addon">From:</span> <input type="date" name="FromDate" placeholder="From" class="form-control " />
                </div>
                <div class="form-group input-group">
                    <span class="input-group-addon">To:&nbsp;&nbsp;&nbsp;&nbsp; </span> <input type="date" name="ToDate" placeholder="To" class="form-control" />
                </div>
            </div>
            <div class="col-md-2">
                
                    @Html.DropDownList("InsuranceId", null, htmlAttributes: new { @class = "form-control" })
                
                    @if (User.IsInRole("Admins"))
					{
                        @Html.DropDownList("BranchId", null, htmlAttributes: new { @class = "form-control" })
                    }
             
            </div>
        </div>
		<div class="row justify-content-center">
			<div class="col-md-2">
                <button type="submit" value="Search" class="btn btn-default btn-block" >
					<i class="fas fa-search"></i> Search</button>
			</div>
			<div class="col-md-3">
				<a class="btn btn-default btn-block" href=@Url.Action("Create")>
                        <i class="fas fa-plus-circle"></i> Create New Invoice
                    </a>
			</div>
		</div>
    }
    @if (Model != null && Model.Count() > 0)
    {	<div class="table-responsive">
            <table class="table table-hover">
                <tr>
                    <th>
                        @Html.DisplayNameFor(model => model.Id)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.ClientName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.ClientPhoneNumber)
                    </th>
                    @if (User.IsInRole("Admins"))
                    {
                        <th>
                            @Html.DisplayNameFor(model => model.Branch.BranchName)
                        </th>
                    }
                    <th>
                        @Html.DisplayNameFor(model => model.Insurance.Description)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Date)
                    </th>
                    <th></th>
                </tr>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.Id)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.ClientName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.ClientPhoneNumber)
                        </td>
                        @if (User.IsInRole("Admins"))
                        {
                            <td>
                                @Html.DisplayFor(modelItem => item.Branch.BranchName)
                            </td>
                        }
                        <td>
                            @Html.DisplayFor(modelItem => item.Insurance.Description)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Date)
                        </td>
                        <td style="white-space:nowrap;">
                            <a title="Details" @@click="fetchDetails(@item.Id)" data-toggle="modal" data-target="#myModal">
                                <i class="fas fa-file-alt fa-lg" style="color:#a72abd"></i>
                            </a>@if (User.IsInRole("Admins"))
                            {
                                    <span>|</span><a title="Delete" href=@Url.Action("Delete", new { id = item.Id }) onclick="return confirm('Are you sure you want to delete this invoice?')">
                                        <i class="fas fa-trash-alt fa-lg"></i>
                                    </a>
                            }
                            
                        </td>
                    </tr>
                }
            </table>
		</div>
    }
    else
    {
        <div class="alert">
            <h4 style="font-weight:bolder">
                <span class="glyphicon glyphicon-remove">
                </span> No rows to display!
            </h4>
        </div>
    }
    @switch ((string)ViewBag.Result)
    {
        case "Created":
            {
                <div class="alert alert-success" id="error-div">
                    <span class="glyphicon glyphicon-ok"></span>
                    <span>
                        The invoice has been created successfully.
                    </span>
                </div>
            }
            break;
        case "Edited":
            {
                <div class="alert alert-success" id="error-div">
                    <span class="glyphicon glyphicon-ok"></span>
                    <span>
                        The invoice has been edited successfully.
                    </span>
                </div>
            }
            break;
        case "Deleted":
            {
                <div class="alert alert-success" id="error-div">
                    <i class="fas fa-check"></i>
                    <span> The invoice has been deleted successfully.</span>
                </div>
            }
            break;
        case "Error":
            {
                <div class="alert alert-danger" id="error-div">
                    <span class="glyphicon glyphicon-remove"></span>
                    <span>
                        You can not delete this invoice!
                    </span>
                </div>
            }
            break;
    }

    @section scripts{
        <script>
        $(document).ready( function() {
            $("#error-div").delay(3000).fadeOut();
    });
        </script>
    }


    <!--------------- Modal ---------------->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content panel panel-primary">
                <div class="modal-header panel-heading">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h3 class="modal-title text-center" id="myModalLabel">Invoice Details</h3>
                </div>
                <div class="modal-body">
                    <!---- MODAL BODY ------>
                    <h1 v-show="loading"><i class="fas fa-spinner"></i></h1>
                    <div v-show="!loading">
                        <div class="panel panel-primary text-center ">
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Invoice Number: </strong> <span>{{selectedInvoice.InvoiceId}}</span></p>
                                        <p><strong>Date: </strong> <span>{{selectedInvoice.Date}}</span></p>
                                        <p><strong>Branch Name: </strong> <span>{{selectedInvoice.BranchName}}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Client: </strong> <span>{{selectedInvoice.ClientName}}</span></p>
                                        <p><strong>Phone: </strong> <span>{{selectedInvoice.ClientPhoneNumber}}</span></p>
                                        <p><strong>Insurance Description: </strong> <span>{{selectedInvoice.InsuranceDescription}}</span></p>
                                    </div>
                                </div>
                                <p><strong>Total: </strong> <span>{{selectedInvoice.Total}}</span></p>
                                <p><strong>Discount: </strong> <span>{{selectedInvoice.Discount}}%</span></p>
                                <p><strong>Final Price: </strong> <span>{{selectedInvoice.Total - (selectedInvoice.Total * ( selectedInvoice.Discount / 100 ))}}</span></p>
                                <hr />
                                <div class="form-group row" v-for="(eye, i) in selectedInvoice.Eyes">
                                    <label v-if="eye.IsRightEye == false">Left Eye</label>
                                    <label v-if="eye.IsRightEye == true">Right Eye</label>
                                    <div class="input-group form-group">
                                        <span class="input-group-addon">Sphere</span>
                                        <span class="form-control">{{eye.Sphere}}</span>
                                        <span class="input-group-addon">Cylinder</span>
                                        <span class="form-control">{{eye.Cylinder}}</span>
                                        <span class="input-group-addon">Axis</span>
                                        <span class="form-control">{{eye.Axis}}</span>
                                        <span class="input-group-addon">Addition</span>
                                        <span class="form-control">{{eye.Addition}}</span>
                                    </div>
                                </div>
                                <hr />
                                <div class="form-group row" >
                                    <label>Items</label>
                                    <table class="table table-hover">
                                        <tr>
                                            <th>Model Number</th>
                                            <th style="text-align:center">Title</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                        </tr>
                                        <tr v-for="(item, i) in selectedInvoice.Items">
                                            <td>{{item.ModelNumber}}</td>
                                            <td>{{item.Color}} {{item.ItemType}} {{item.BrandName}}</td>
                                            <td>{{item.Quantity}}</td>
                                            <td>{{item.Price}}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-------- END: MODAL BODY ------------>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-dismiss="modal">Close</button>
                    <button Class="btn btn-warning" onclick="myFunction()">Print this page</button>
                </div>
            </div>
        </div>
    </div>
</div>     
<!--------------------------END: MODAL----------------------------->
     
@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>*@
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/vue-toastr-2/dist/vue-toastr-2.js"></script>
<script>
function myFunction() {
    window.print();
}
</script>
<script>
        class Eye {
            constructor(sphere, cylinder, axis, addition) {
                this.sphere = sphere
                this.cylinder = cylinder
                this.axis = axis
                this.addition = addition
            }
        }

        var app = new Vue({
            el: '#app',

            data() {
                return {
                    title: 'Show invoices',
                    loading: false,
                    searchTxt: 'yoyo',
                    result: [],
                    selectedInvoice: {}
                }
            },
            methods: {
                fetchInvoices(){
                    this.loading = true
                    axios.get('https://jsonplaceholder.typicode.com/posts')
                    .then((response) => {
                            this.result = response.data
                            //this.$toastr.success('Results are loaded successfully!');
                            this.loading = false
                        })
                        .catch((error) => {
                            console.log(error)
                            this.$toastr.error('Please try again later.', 'Error while loading invoices!');
                            this.loading = false
                        })
                },
                fetchDetails(id){
                    this.loading = true
                    axios.get('@Url.Action("GetInvoiceDetailsById", "Invoices")'+'/'+id)
                    .then((response) => {
                            this.selectedInvoice = response.data
                            //this.$toastr.success('Invoice loaded !!');
                            this.loading = false
                        })
                        .catch((error) => {
                            console.log(error)
                            this.$toastr.error('Please try again later.', 'Error reaching the invoice!');
                            this.loading = false
                        })
                }
            },
            created() {
                //this.apploaded = true
                this.fetchInvoices()
            }
        })
</script>
@*<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>*@
<script defer src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>